<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>3D Secure Confirmation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 100px;
        }

        #status {
            font-size: 1.2rem;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <h1>Processing 3D Secure Payment...</h1>
    <div id="status">Please wait while we confirm your payment.</div>

    <input id="bearerToken"></div>
    <script>
        const bearerToken = document.getElementById('bearerToken').value;

        async function confirmPayment() {
            const params = new URLSearchParams(window.location.search);

            const ref = params.get("REF");

            if (!ref) {
                document.getElementById("status").innerText = "Missing required parameters.";
                return;
            }

            try {

                const url = `http://localhost:25713/worldline/v1.0/payments/find`;

                const response = await fetch(url, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        'Authorization': bearerToken,
                        'accept': 'application/json',
                        'N3O-Ignore-Validation-Warnings': 'false',
                        'N3O-Subscription-Id': '00000006-0000-0000-0000-000000000000',
                    },
                    body: JSON.stringify({ "worldlinePaymentId": ref })
                });

                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}`);
                }

                const result = await response.json();

                if (result.items[0].status === "paid") {
                    document.getElementById("status").innerText = `Payment successful! Thank you. ${JSON.stringify(result)}`;
                } else {
                    document.getElementById("status").innerText = `Payment failed: ${result}`;
                }

            } catch (error) {
                document.getElementById("status").innerText = "Error confirming payment. Please try again.";

                setTimeout(() => confirmPayment(), 1000); 
            }
        }

        // Trigger confirmation when page loads
        confirmPayment();
    </script>
</body>

</html>